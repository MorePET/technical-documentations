#!/bin/bash
# Pre-commit hook for technical documentation
# Automatically rebuilds affected components when source files change

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}üîç Pre-commit: Checking for documentation changes...${NC}"

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# Flags to track what needs rebuilding
REBUILD_COLORS=false
REBUILD_DIAGRAMS=false
REBUILD_DOCS=false

# Check what files were modified
while IFS= read -r file; do
    case "$file" in
        colors.json)
            echo -e "${YELLOW}  ‚Ä¢ colors.json modified${NC}"
            REBUILD_COLORS=true
            REBUILD_DIAGRAMS=true  # Diagrams depend on colors
            REBUILD_DOCS=true
            ;;
        diagrams/*.typ)
            echo -e "${YELLOW}  ‚Ä¢ Diagram source modified: $file${NC}"
            REBUILD_DIAGRAMS=true
            REBUILD_DOCS=true
            ;;
        technical-doc-example.typ|technical-documentation-package.typ)
            echo -e "${YELLOW}  ‚Ä¢ Document source modified: $file${NC}"
            REBUILD_DOCS=true
            ;;
        *.py)
            # Build scripts changed - rebuild everything to be safe
            if [[ "$file" == build-*.py ]] || [[ "$file" == add-styling.py ]] || [[ "$file" == post-process-html.py ]]; then
                echo -e "${YELLOW}  ‚Ä¢ Build script modified: $file${NC}"
                REBUILD_COLORS=true
                REBUILD_DIAGRAMS=true
                REBUILD_DOCS=true
            fi
            ;;
    esac
done <<< "$STAGED_FILES"

# If nothing needs rebuilding, exit early
if [ "$REBUILD_COLORS" = false ] && [ "$REBUILD_DIAGRAMS" = false ] && [ "$REBUILD_DOCS" = false ]; then
    echo -e "${GREEN}‚úì No documentation changes detected${NC}"
    exit 0
fi

echo ""
echo -e "${BLUE}üî® Rebuilding affected components...${NC}"

# Rebuild colors if needed
if [ "$REBUILD_COLORS" = true ]; then
    echo -e "${YELLOW}  ‚Üí Regenerating color files...${NC}"
    python3 build-colors.py > /dev/null 2>&1
    git add generated/colors.css generated/colors.typ
    echo -e "${GREEN}  ‚úì Colors updated${NC}"
fi

# Rebuild diagrams if needed
if [ "$REBUILD_DIAGRAMS" = true ]; then
    echo -e "${YELLOW}  ‚Üí Recompiling diagrams...${NC}"
    python3 build-diagrams.py > /dev/null 2>&1
    git add diagrams/*.svg
    echo -e "${GREEN}  ‚úì Diagrams updated${NC}"
fi

# Rebuild documentation if needed
if [ "$REBUILD_DOCS" = true ]; then
    echo -e "${YELLOW}  ‚Üí Recompiling PDF...${NC}"
    typst compile technical-doc-example.typ technical-doc-example.pdf > /dev/null 2>&1
    git add technical-doc-example.pdf
    echo -e "${GREEN}  ‚úì PDF updated${NC}"
    
    echo -e "${YELLOW}  ‚Üí Recompiling HTML...${NC}"
    python3 build-html.py technical-doc-example.typ technical-doc-example.html > /dev/null 2>&1
    git add technical-doc-example.html colors.css
    echo -e "${GREEN}  ‚úì HTML updated${NC}"
fi

echo ""
echo -e "${GREEN}‚úÖ Pre-commit build complete!${NC}"
echo -e "${BLUE}Updated files have been staged for commit${NC}"
echo ""

exit 0

